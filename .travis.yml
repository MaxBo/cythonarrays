# safelist
#branches:
#  only:
#  - master

language: python

matrix:
    include:
        - python: 3.5
          env:
            - TRAVIS_PYTHON_VERSION=3.5
            - CONDA_PY=35
            - CONDA_NPY=114
        - python: 3.6
          env:
            - TRAVIS_PYTHON_VERSION=3.6
            - CONDA_PY=36
            - CONDA_NPY=114
            - CREATE_DOCS=1

env:
  global:
    - ANACONDA_USERNAME=MaxBo
    # ANACONDA_TOKEN
    - secure: x9f4pyER+zwP5UoQcgJFFrGSBL1RHXcjasEQ+cLzM+hTKZ9ppMgaT8smru1xaNcZ0GzZnpGip3XJkJlLwm6dHB10TPuO8hutvBwfwBQkr8F0AiLsmczIogPScWHGoi1nzYhWlTlvKIFAMVn0JarRg+hLdbMJHkC+HYLfyn1xrhEM+Yu19qGLkPAscW2DvngPXulPVG3BTMnRgnWKcHBUNtEQDgGChTdLOe5d/Vry6SkGLOInjHmbm9oYbwYY8IhJC7jzdqlM5I+gjCNumY9Yq8Z8d6MxpiIL8L1W85kp7HFPYBGxmGloEATKphX3SeZ7j4dNHbXL2oDKOaeHtOzmL+F+EgE6il2MpGxHDY6QkeBPBeFlPt/Cu+pDAPIcLoLNtMx1wLa2E1HPU5MdUgaRAu4pYTF+dVqif1Vocmjq/xae94vSEfdBrxSjgqTkDiB+tOdELCUM5ITi3J6A38Z+JKkwgp+p2fvseeCvKETYpehixVh6k6l9RoXACmbliXjflOPZxWpf5/ljaOUmXS75SHfQGlf6XPo8afEqxzZgrn/+AxARguChwMuya89JY8obwbfqgfZGZ4oX2HI7dJI1455NKqSxuwphAahGrqqZJ5Nc/+9WIyK2q850das1cjaSU3n+njsezBm+KJvZRKve6DRGJWcaY4C1p7eQ9CnRaj0=
    - TWINE_USERNAME=MaxBo
    - TWINE_REPOSITORY=pypi
    - TWINE_REPOSITORY_URL=https://upload.pypi.org/legacy/
    # TWINE_PASSWORD
    - secure: ddmOIwF2K03J4Do/5bDU4dNhCZ5urACOPfThiWDmJM3FzMpcfwiQQaBN9mA79k6bWAP7Xbu9zEFo9plBpzpUn5oz8+pFmMkP6B2+SSLd5UivcdkmCNuME0fpAX/aZzZPttZna4Yq0xLcgMbOdgVWPH2LS/yrjkfqZ+TebjxIbDNe+ij+AWuUBudVsRqEkwBDlO+uw/dfPq/9NSDh/aZOMfzJaeAQ/rduEyYSJEBXcYxxkmv3DjtDgJmhNUHSsVRUHZu4lU7I6JE99wVsnuTMSP5Q0nSCXmy2e4fTurluAFXK/3h5wND5vXTLnJqbHRXIaJW/XxempG+xPg/kxJUuK29aDZgObEmJ8kXK0d4DX+TkBZaMzx7E6AfAKm2ZoBmkWSWvCHm4VLNThrflA0lz8zk6u2Zh6wb+Z2dtN5XhQcfe4Pe7t9xkmKoPj+4b/aoEyhImG96uCQD0zLhV/8kVohyPGZSezPqn/C1+evrP/7xO3lcZBYsGoE5zv8SqHo9RIOMfzn6HGJoP7YGdGP53iWBBs7ZkWjZhKKj9Y6gcOUHLsfjbsq5AbTBEqq9qKOC7fDR3zOZh4fP6d9sAY/Czy/xb0oaDJmm47xYCnrFnNHcDBxYER9j71dit3WCY4B7YnL0g09WtV1duAS64gBqzOJbAIykak9zCNeHPLzquAJE=

install:
  - sudo apt-get update
  # We do this conditionally because it saves us some downloading if the
  # version is the same.
  - if [[ "$TRAVIS_PYTHON_VERSION" == "2.7" ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh;
    else
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  - conda install conda-build
  - conda install anaconda-client
  # Useful for debugging any issues with conda
  - conda info -a

  - conda config --set show_channel_urls true
  - conda config --remove channels defaults
  - conda config --add channels defaults
  - conda config --add channels conda-forge
  - conda config --add channels MaxBo

  - conda install cythoninstallhelpers

  - conda create -q -n test-environment python=$TRAVIS_PYTHON_VERSION
  - export TMPDIR=`dirname $(mktemp -u -t tmp.XXXXXXXXXX)`
  - export CONDA_BLD_PATH=$TMPDIR
  - conda build cythoninstallhelpers/conda.recipe
  - conda install -y --use-local cythoninstallhelpers

  - source activate test-environment
  - conda install -y sphinx numpydoc
  - pip install --user travis-sphinx
  - export PATH=$HOME/.local/bin:$PATH
  - conda install pytest-cov

script:
  # Your test script goes here
  - conda info -a
  - conda build cythoninstallhelpers/conda.recipe
  - conda install -y --use-local cythoninstallhelpers
  - conda build cythonarrays/conda.recipe
  - conda build matrixconverters/conda.recipe

  # build documentation
  - if [ "${CREATE_DOCS}" = "1" ]; then
      conda install -y --use-local cythonarrays matrixconverters;
      sphinx-apidoc -f --separate -o docs_rst/cythoninstallhelpers cythoninstallhelpers/src/cythoninstallhelpers;
      sphinx-apidoc -f --separate -o docs_rst/cythonarrays cythonarrays/src/cythonarrays;
      sphinx-apidoc -f --separate -o docs_rst/matrixconverters matrixconverters/src/matrixconverters;
      travis-sphinx build --source docs_rst --nowarn;
    fi

after_success:
  - if [ "${CREATE_DOCS}" = "1" ]; then travis-sphinx deploy; fi

  - if [ "${TRAVIS_TAG}" ]; then
      anaconda -t $ANACONDA_TOKEN upload --user $ANACONDA_USERNAME $CONDA_BLD_PATH/linux-64/cythoninstallhelpers-*.tar.bz2;
      anaconda -t $ANACONDA_TOKEN upload --user $ANACONDA_USERNAME $CONDA_BLD_PATH/linux-64/cythonarrays-*.tar.bz2;
      anaconda -t $ANACONDA_TOKEN upload --user $ANACONDA_USERNAME $CONDA_BLD_PATH/linux-64/matrixconverters-*.tar.bz2;

      conda install -y twine;
      cd $TRAVIS_BUILD_DIR/cythoninstallhelpers;
      python setup.py sdist bdist_wheel;
      twine upload --skip-existing dist/*;
      conda install -y cythoninstallhelpers;
      cd $TRAVIS_BUILD_DIR/cythonarrays;
      python setup.py sdist bdist_wheel;
      twine upload --skip-existing dist/*;
      conda install -y cythonarrays;
      cd $TRAVIS_BUILD_DIR/matrixconverters;
      python setup.py sdist bdist_wheel;
      twine upload --skip-existing dist/*;

    fi
